<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>お気に入り店舗一覧</title>
    <link rel="stylesheet" href="favorites.css">
</head>
<body>
    <div class="container">
        <h1>お気に入り店舗一覧</h1>
        <ul id="favorites-list">
            <!-- ここにお気に入り店舗リストをJSで挿入 -->
        </ul>
        <a class="back-link" href="favorites_search.html">店舗検索に戻る</a>
    </div>
    
    <!-- 共通リンク生成用ユーティリティ -->
    <script src="linkUtils.js"></script>
    <script>
    // ローカルストレージからお気に入り店舗・店舗リストを取得
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    const storeList = JSON.parse(localStorage.getItem('storeList') || '[]');
    const list = document.getElementById('favorites-list');

    if (favorites.length === 0) {
        // お気に入りがない場合の表示
        list.innerHTML = '<li>お気に入り店舗はありません。</li>';
    } else {
        // お気に入り店舗を1件ずつリスト表示
        favorites.forEach((store, idx) => {
            const li = document.createElement('li');
            // storeListからid一致する店舗情報を取得（公式HPなど補完）
            let storeData = store;
            if (store.id && Array.isArray(storeList)) {
                const found = storeList.find(s => s.id === store.id);
                if (found) {
                    storeData = { ...store, ...found };
                }
            }
            // 店舗名：公式HPがあればリンク、なければ黒文字span
            let nameHtml = '';
            if (storeData.url && storeData.url !== '' && storeData.url !== 'undefined' && !/^https?:\/\/www\.google\.com\/maps/.test(storeData.url)) {
                // http/httpsがなければ付与
                let safeUrl = storeData.url;
                if (!/^https?:\/-\//i.test(safeUrl)) {
                    safeUrl = 'https://' + safeUrl;
                }
                nameHtml = `<a href="${safeUrl}" class="store-name" target="_blank" rel="noopener noreferrer">${storeData.name}</a>`;
            } else {
                nameHtml = `<span class="store-name" style="color:#222">${storeData.name}</span>`;
            }
            // 地図で見るリンク（Googleマップ検索URL）
            const mapUrlHtml = storeData.name
                ? `<a class="map-link green-map-url" href="https://www.google.com/maps/search/?api=1&language=ja&hl=ja&query=${encodeURIComponent(storeData.name)}" target="_blank">地図で見る</a>`
                : '';
            // 店舗情報・削除ボタンをリストに追加
            li.innerHTML = `${nameHtml} <span class="store-address">${storeData.address}</span> ${mapUrlHtml} <button class="remove-fav-btn styled-fav-btn" data-idx="${idx}"><span class="remove-fav-icon">&#128465;</span> 削除</button>`;
            list.appendChild(li);
        });
        // 削除ボタンのイベントリスナー登録
        document.querySelectorAll('.remove-fav-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const idx = parseInt(this.getAttribute('data-idx'), 10);
                favorites.splice(idx, 1);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                location.reload(); // 即時反映
            });
        });
    }
    </script>
</body>
</html>
