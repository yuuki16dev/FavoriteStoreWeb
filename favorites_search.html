<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>お気に入り店舗検索</title>
    <link rel="stylesheet" href="favorites.css">
</head>
<body>
    <div class="container">
        <h1>お気に入り店舗検索</h1>
        <form method="get" action="favorites_search.html" style="margin-bottom: 24px; text-align:center;" id="search-form">
            <input type="text" name="search_query" placeholder="地名や店舗名で検索" style="width:60%;padding:8px;" autocomplete="off">
            <button type="submit">マップで検索</button>
        </form>
        <!-- 検索ワードが入力された場合のGoogleマップリンクはJSやPHPで動的に生成可能 -->
        <div id="map-link-area" style="text-align:center; margin-bottom:24px;"></div>
        <div id="map-embed-area" style="text-align:center; margin-bottom:16px;"></div>
        <div id="search-result-list-area">
            <h2 style="text-align:center; color:#2d3748; margin-top:32px;">検索結果 店舗一覧</h2>
            <div id="search-result-list" style="margin-bottom:24px;"></div>
            <script type="application/ld+json" id="seo-json-ld"></script>
        </div>
        <a class="back-link" href="favorites_list.html">お気に入り店舗一覧へ</a>
    </div>
    <script src="linkUtils.js"></script>
    <script>
    // JSで検索ワードからGoogleマップリンクと埋め込みマップを生成
    const params = new URLSearchParams(window.location.search);
    const query = params.get('search_query');
    // フォーム内容やマップ・リンクをクリアする処理を削除
    if(query) {
        const mapUrl = 'https://www.google.com/maps/search/?api=1&language=ja&hl=ja&query=' + encodeURIComponent(query);
        document.getElementById('map-link-area').innerHTML = `<a href="${mapUrl}" class="map-link" target="_blank">「${query}」をGoogleマップで検索</a>`;
        // Googleマップ埋め込みiframe
        const embedUrl = 'https://www.google.com/maps?q=' + encodeURIComponent(query) + '&hl=ja&output=embed';
        document.getElementById('map-embed-area').innerHTML = `<iframe width="100%" height="350" frameborder="0" style="border:0;border-radius:8px;" src="${embedUrl}" allowfullscreen></iframe>`;
        // Google Places API（PHP中継）から店舗データ取得
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;
                console.log('[DEBUG] 取得した現在位置:', userLat, userLon);
                // 検索ワードが具体的な店舗名（例: 2文字以上のひらがな・カタカナ・漢字・アルファベット・数字を含む）なら通常検索
                const isSpecificName = /^[\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF\uFF10-\uFF19\d]{2,}$/.test(query);
                // Google Places APIは常にText Searchで対応
                fetch('api/google_places.php?query=' + encodeURIComponent(query) + '&lat=' + userLat + '&lon=' + userLon)
                  .then(res => {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.json();
                  })
                  .then(data => {
                    // デバッグ用: レスポンスを画面に表示
                    document.getElementById('search-result-list').innerHTML =
                      '<pre style="background:#f8f8f8;color:#333;font-size:0.95em;overflow:auto;max-width:100vw;">' +
                      JSON.stringify(data, null, 2) + '</pre>';
                    if (!data.results || data.results.length === 0) {
                      document.getElementById('search-result-list').innerHTML += '<div style="color:#c00;text-align:center;">検索結果がありません</div>';
                      return;
                    }
                    // 20km未満の店舗のみ抽出し、近い順で最大50件表示
                    const stores = data.results.map(store => {
                        const lat = store.geometry && store.geometry.location ? store.geometry.location.lat : null;
                        const lon = store.geometry && store.geometry.location ? store.geometry.location.lng : null;
                        if (lat !== null && lon !== null) {
                            const toRad = deg => deg * Math.PI / 180;
                            const R = 6371;
                            const dLat = toRad(lat - userLat);
                            const dLon = toRad(lon - userLon);
                            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                                Math.cos(toRad(userLat)) * Math.cos(toRad(lat)) *
                                Math.sin(dLon/2) * Math.sin(dLon/2);
                            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                            const distance = R * c;
                            store._distance = distance;
                        } else {
                            store._distance = Infinity;
                        }
                        return store;
                    }).filter(store => isFinite(store._distance) && store._distance < 20);
                    stores.sort((a, b) => a._distance - b._distance);
                    renderList(stores.slice(0, 50), query);
                  })
                  .catch(async err => {
                    let errorText = '';
                    try {
                      const res = await fetch('api/google_places.php?query=' + encodeURIComponent(query));
                      errorText = await res.text();
                    } catch (e) {}
                    console.error('API取得エラー:', err, errorText);
                    document.getElementById('search-result-list').innerHTML =
                      '<div style="color:#c00;text-align:center;">店舗情報の取得に失敗しました<br><pre style="text-align:left;white-space:pre-wrap;background:#f8f8f8;padding:8px;border-radius:4px;max-width:90vw;overflow:auto;">' +
                      (errorText ? errorText.replace(/[<>]/g, c => ({'<':'&lt;','>':'&gt;'}[c])) : '') +
                      '</pre></div>';
                  });
            }, function() {
                // 位置情報取得不可時は従来通り
                fetch('api/google_places.php?query=' + encodeURIComponent(query))
                  .then(res => {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.json();
                  })
                  .then(data => {
                    // デバッグ用: レスポンスを画面に表示
                    document.getElementById('search-result-list').innerHTML =
                      '<pre style="background:#f8f8f8;color:#333;font-size:0.95em;overflow:auto;max-width:100vw;">' +
                      JSON.stringify(data, null, 2) + '</pre>';
                    if (!data.results || data.results.length === 0) {
                      document.getElementById('search-result-list').innerHTML += '<div style="color:#c00;text-align:center;">検索結果がありません</div>';
                      return;
                    }
                    renderList(data.results.slice(0, 50), query);
                  })
                  .catch(async err => {
                    let errorText = '';
                    try {
                      const res = await fetch('api/google_places.php?query=' + encodeURIComponent(query));
                      errorText = await res.text();
                    } catch (e) {}
                    console.error('API取得エラー:', err, errorText);
                    document.getElementById('search-result-list').innerHTML =
                      '<div style="color:#c00;text-align:center;">店舗情報の取得に失敗しました<br><pre style="text-align:left;white-space:pre-wrap;background:#f8f8f8;padding:8px;border-radius:4px;max-width:90vw;overflow:auto;">' +
                      (errorText ? errorText.replace(/[<>]/g, c => ({'<':'&lt;','>':'&gt;'}[c])) : '') +
                      '</pre></div>';
                  });
            });
        } else {
            // 位置情報取得不可時は従来通り
            fetch('api/google_places.php?query=' + encodeURIComponent(query))
              .then(res => {
                if (!res.ok) throw new Error('Network response was not ok');
                return res.json();
              })
              .then(data => {
                // デバッグ用: レスポンスを画面に表示
                document.getElementById('search-result-list').innerHTML =
                  '<pre style="background:#f8f8f8;color:#333;font-size:0.95em;overflow:auto;max-width:100vw;">' +
                  JSON.stringify(data, null, 2) + '</pre>';
                if (!data.results || data.results.length === 0) {
                  document.getElementById('search-result-list').innerHTML += '<div style="color:#c00;text-align:center;">検索結果がありません</div>';
                  return;
                }
                renderList(data.results.slice(0, 50), query);
              })
              .catch(async err => {
                let errorText = '';
                try {
                  const res = await fetch('api/google_places.php?query=' + encodeURIComponent(query));
                  errorText = await res.text();
                } catch (e) {}
                console.error('API取得エラー:', err, errorText);
                document.getElementById('search-result-list').innerHTML =
                  '<div style="color:#c00;text-align:center;">店舗情報の取得に失敗しました<br><pre style="text-align:left;white-space:pre-wrap;background:#f8f8f8;padding:8px;border-radius:4px;max-width:90vw;overflow:auto;">' +
                  (errorText ? errorText.replace(/[<>]/g, c => ({'<':'&lt;','>':'&gt;'}[c])) : '') +
                  '</pre></div>';
              });
        }
    } else {
        document.getElementById('search-result-list-area').style.display = 'none';
        document.getElementById('map-link-area').innerHTML = '';
        document.getElementById('map-embed-area').innerHTML = '';
    }
    // Google Places API用のrenderList
    function renderList(stores, query) {
        // 位置情報取得→近い順にソート
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(pos) {
                const userLat = pos.coords.latitude;
                const userLon = pos.coords.longitude;
                // 距離計算関数
                function getDistance(lat1, lon1, lat2, lon2) {
                    const toRad = deg => deg * Math.PI / 180;
                    const R = 6371; // km
                    const dLat = toRad(lat2 - lat1);
                    const dLon = toRad(lon2 - lon1);
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    return R * c;
                }
                stores.forEach(store => {
                    const lat = store.geometry && store.geometry.location ? store.geometry.location.lat : null;
                    const lon = store.geometry && store.geometry.location ? store.geometry.location.lng : null;
                    if (lat !== null && lon !== null) {
                        store._distance = getDistance(userLat, userLon, lat, lon);
                    } else {
                        store._distance = Infinity;
                    }
                });
                // 近い順（昇順）でソート
                stores.sort((a, b) => a._distance - b._distance);
                renderListCore(stores, query, true);
            }, function() {
                renderListCore(stores, query, false);
            });
        } else {
            renderListCore(stores, query, false);
        }
    }
    // Google Places API用の描画本体
    function renderListCore(stores, query, showDistance) {
        window._lastStores = stores;
        let jsonLd = [];
        const resultList = document.getElementById('search-result-list');
        resultList.innerHTML = stores.map(store => {
            const name = store.name || '';
            const address = store.vicinity || store.formatted_address || '';
            const placeId = store.place_id || '';
            const lat = store.geometry && store.geometry.location ? store.geometry.location.lat : '';
            const lon = store.geometry && store.geometry.location ? store.geometry.location.lng : '';
            const mapUrl = (lat && lon)
                ? `https://www.google.com/maps/search/?api=1&query=${lat},${lon}&query_place_id=${placeId}`
                : '';
            // 公式HP（website）があればそれを使う
            const website = store.website ? store.website : '';
            // 店舗名リンクとマップURLリンクを共通関数で生成
            const nameHtml = createStoreNameLink(name, website);
            const mapUrlHtml = createMapUrlLink(lat, lon);
            jsonLd.push({
                "@context": "https://schema.org",
                "@type": "LocalBusiness",
                "name": name,
                "address": address,
                "url": mapUrl,
                "hasMap": mapUrl
            });
            let distStr = '';
            if (showDistance && typeof store._distance === 'number' && isFinite(store._distance)) {
                distStr = `<span style='color:#888;font-size:0.92em;margin-left:8px;'>(約${store._distance.toFixed(2)}km)</span>`;
            }
            // お気に入り判定
            let isFavorite = false;
            try {
                const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
                isFavorite = favs.some(f => f.id === placeId);
            } catch(e) {}
            return `
<div class="store-card">
  <div style="font-size:0.95em;color:#202124;">
    ${nameHtml}
    ${distStr}
  </div>
  <div style="font-size:0.92em;word-break:break-all;">
    <a class="map-link green-map-url" href="${mapUrl}" target="_blank">地図で見る</a>
  </div>
  <div style="font-size:0.98em;color:#4d5156;margin-top:2px;">${highlight(address)}</div>
  ${isFavorite
    ? '<span class="favorite-registered">★ お気に入り登録済み</span>'
    : `<button class="favorite-btn add-favorite-btn" 
        data-id="${placeId}"
        data-name="${name.replace(/\"/g, '&quot;')}"
        data-address="${address.replace(/\"/g, '&quot;')}"
        data-url="${mapUrl}"
        data-mapurl="${mapUrl}"
        data-lat="${lat}"
        data-lng="${lon}"
        >★ お気に入り登録</button>`}
</div>
`;
        }).join('');
        document.getElementById('seo-json-ld').textContent = JSON.stringify(jsonLd, null, 2);
        // 画面描画後にイベントリスナーを付与
        setTimeout(() => {
          // 「お気に入り登録」ボタンにクリックイベントを付与
          document.querySelectorAll('.add-favorite-btn').forEach(btn => {
            btn.addEventListener('click', function() {
              // ボタンのdata属性から店舗情報を取得
              const store = {
                id: this.getAttribute('data-id'),
                name: this.getAttribute('data-name'),
                address: this.getAttribute('data-address'),
                url: this.getAttribute('data-url'),
                mapUrl: this.getAttribute('data-mapurl'),
                lat: this.getAttribute('data-lat'),
                lng: this.getAttribute('data-lng')
              };
              // お気に入り登録処理
              addFavorite(store);
              // ボタンを即時「お気に入り登録済み」表記に変更
              this.outerHTML = '<span class="favorite-registered">★ お気に入り登録済み</span>';
            });
          });
        }, 0);
    }
    // ハイライト用（検索ワードを強調表示）
    function highlight(text) {
        // 検索ワードに一致する部分をspanで強調
        const match = new RegExp(`(${query.replace(/([.*+?^${}()|\[\]\\\/])/, '\\$1')})`, 'gi');
        return text.replace(match, '<span class="highlight">$1</span>');
    }
    // お気に入り登録処理
    function addFavorite(store) {
        // store: {id, name, address, url, ...}
        const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
        const storeList = JSON.parse(localStorage.getItem('storeList') || '[]');
        // storeListに同じIDがなければ追加、あれば上書き
        const idx = storeList.findIndex(s => s.id === store.id);
        if (idx === -1) {
            storeList.push(store);
        } else {
            storeList[idx] = store;
        }
        localStorage.setItem('storeList', JSON.stringify(storeList));
        // お気に入りにも追加
        if (!favorites.some(f => f.id === store.id)) {
            favorites.push({ id: store.id });
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }
    }
    // Place Details APIでwebsiteを取得してから保存
    function fetchPlaceDetailsAndSave(placeId, name, address) {
        fetch(`https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=website&key=YOUR_API_KEY`)
          .then(res => res.json())
          .then(data => {
            const website = data.result && data.result.website ? data.result.website : '';
            const store = {
              id: placeId,
              name: name,
              address: address,
              url: website, // ここに公式HP
              // ...他の情報
            };
            // favoritesとstoreListに保存
            addFavorite(store);
          });
    }
    </script>
</body>
</html>
